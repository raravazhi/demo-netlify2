<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.93.0" />
<meta name="robots" content="index, follow">

<script type="application/ld+json">
  {
      "@context" : "http://schema.org",
      "@type" : "WebSite",
      "mainEntityOfPage": {
           "@type": "WebPage",
           "@id": "https:\/\/vmware.github.io\/ml-ops-platform-for-vsphere\/"
      },
      "articleSection" : "docs",
      "name" : "",
      "headline" : "",
      "description" : "Lab 7: Kubeflow Pipeline Install Kubeflow Pipeline Package !pip install kfp --upgrade --user --quiet # confirm the kfp sdk ! pip show kfp Example 1: Facial Keypoint Detection In this example, we would build pipeline components from docker images.\nAbout this Model This model comes from Kaggle Competition. The objective of this task is to predict keypoint positions on face images, which can be used as a building block in several applications, such as analysing facial expressions and biometrics recognition.",
      "inLanguage" : "en-US",
      "author" : "",
      "creator" : "",
      "publisher": "",
      "accountablePerson" : "",
      "copyrightHolder" : "",
      "copyrightYear" : "0001",
      "datePublished": "0001-01-01 00:00:00 \u002b0000 UTC",
      "dateModified" : "0001-01-01 00:00:00 \u002b0000 UTC",
      "url" : "https:\/\/vmware.github.io\/ml-ops-platform-for-vsphere\/docs\/kubeflow-tutorial\/lab5_pipeline_complete\/markdowns\/example1_facialkeypoint\/",
      "wordCount" : "2382",
      "keywords" : [ "Kubeflow" ]
  }
  </script>

<link rel="shortcut icon" href="/ml-ops-platform-for-vsphere/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/ml-ops-platform-for-vsphere/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/ml-ops-platform-for-vsphere/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/ml-ops-platform-for-vsphere/favicons/favicon-32x32.png" sizes="32x32">
<link rel="manifest" href="/ml-ops-platform-for-vsphere/favicons/manifest.json">
<meta name="msapplication-config" content="/ml-ops-platform-for-vsphere/favicons/browserconfig.xml" />
<meta name="msapplication-TileColor" content="#4279f4">
<meta name="theme-color" content="#4279f4">

<title>Kubeflow on vSphere</title>
<meta name="description" content="Lab 7: Kubeflow Pipeline
Install Kubeflow Pipeline Package
!pip install kfp --upgrade --user --quiet
# confirm the kfp sdk
! pip show kfp
Example 1: â€¦">
<meta property="og:title" content="" />
<meta property="og:description" content="Lab 7: Kubeflow Pipeline Install Kubeflow Pipeline Package !pip install kfp --upgrade --user --quiet # confirm the kfp sdk ! pip show kfp Example 1: Facial Keypoint Detection In this example, we would build pipeline components from docker images.
About this Model This model comes from Kaggle Competition. The objective of this task is to predict keypoint positions on face images, which can be used as a building block in several applications, such as analysing facial expressions and biometrics recognition." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://vmware.github.io/ml-ops-platform-for-vsphere/docs/kubeflow-tutorial/lab5_pipeline_complete/markdowns/example1_facialkeypoint/" /><meta property="article:section" content="docs" />

<meta property="article:modified_time" content="2022-11-02T15:23:26+08:00" /><meta property="og:site_name" content="Kubeflow on vSphere" />

<meta itemprop="name" content="">
<meta itemprop="description" content="Lab 7: Kubeflow Pipeline Install Kubeflow Pipeline Package !pip install kfp --upgrade --user --quiet # confirm the kfp sdk ! pip show kfp Example 1: Facial Keypoint Detection In this example, we would build pipeline components from docker images.
About this Model This model comes from Kaggle Competition. The objective of this task is to predict keypoint positions on face images, which can be used as a building block in several applications, such as analysing facial expressions and biometrics recognition.">
<meta itemprop="dateModified" content="2022-11-02T15:23:26+08:00" />
<meta itemprop="wordCount" content="2382">
<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content=""/>
<meta name="twitter:description" content="Lab 7: Kubeflow Pipeline Install Kubeflow Pipeline Package !pip install kfp --upgrade --user --quiet # confirm the kfp sdk ! pip show kfp Example 1: Facial Keypoint Detection In this example, we would build pipeline components from docker images.
About this Model This model comes from Kaggle Competition. The objective of this task is to predict keypoint positions on face images, which can be used as a building block in several applications, such as analysing facial expressions and biometrics recognition."/>




<link rel="preload" href="/ml-ops-platform-for-vsphere/scss/main.min.cfd7574257326fddbc6f33f260c0bda4c6d74394ebf2531282625a18d0a19e75.css" as="style">
<link href="/ml-ops-platform-for-vsphere/scss/main.min.cfd7574257326fddbc6f33f260c0bda4c6d74394ebf2531282625a18d0a19e75.css" rel="stylesheet" integrity="">

<script
  src="https://code.jquery.com/jquery-3.5.1.min.js"
  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
  crossorigin="anonymous"></script>

    
    <link href="/ml-ops-platform-for-vsphere/css/syntax.min.css" rel="stylesheet">

    
    <link href="/ml-ops-platform-for-vsphere/css/copy-code-button.min.css" rel="stylesheet">


  </head>
  <body class="td-page">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand-md navbar-dark  td-navbar">
        <a class="navbar-brand" href="/ml-ops-platform-for-vsphere/">
		<span class="navbar-logo"></span><span class="text-uppercase font-weight-bold">Kubeflow on vSphere</span>
	</a>
	<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#main_navbar" aria-controls="main_navbar" aria-expanded="false" aria-label="Toggle navigation">
		<span class="navbar-toggler-icon"></span>
	</button>
	<div class="collapse navbar-collapse ml-md-auto" id="main_navbar">
		<ul class="navbar-nav ml-auto pt-4 pt-md-0 my-2 my-md-1">
			
			
			<li class="nav-item mr-2 mr-lg-4 mt-1 mt-lg-0">
				
				
				
				
				
				
				<a class="nav-link" href="/ml-ops-platform-for-vsphere/docs/" ><i class='fas fa-book pr-2'></i><span>Documentation</span></a>
			</li>
			
			<li class="nav-item mr-2 mr-lg-4 mt-1 mt-lg-0">
				
				
				
				
				
				
				<a class="nav-link" href="https://github.com/vmware/ml-ops-platform-for-vsphere" target="_blank" ><i class='fab fa-github pr-2'></i><span>GitHub</span></a>
			</li>
			
			
			<li class="nav-item dropdown mt-1 mt-lg-0 mr-2">
				<a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
	Releases
</a>
<div class="dropdown-menu dropdown-menu-md-right dropdown-menu-lg-left" aria-labelledby="navbarDropdownMenuLink">
	
	<a class="dropdown-item" href="https://vmware.github.io/ml-ops-platform-for-vsphere/docs">v1.6</a>
	
	<a class="dropdown-item" href="https://core.vmware.com/aiml-solutions">v1.5</a>
	
</div>

			</li>
			
			
		</ul>
	</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
            
<div id="td-sidebar-menu" class="td-sidebar__inner">
  <form class="td-sidebar__search d-flex align-items-center">
    
    <button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type="button" data-toggle="collapse" data-target="#td-section-nav" aria-controls="td-docs-nav" aria-expanded="false" aria-label="Toggle section navigation">
    </button>
  </form>
  <nav class="collapse td-sidebar-nav foldable-nav" id="td-section-nav">
    <ul class="td-sidebar-nav__section pr-md-3 ul-0">
      <li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id="m-ml-ops-platform-for-vspheredocs-li">
  <a href="/ml-ops-platform-for-vsphere/docs/" class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id="m-ml-ops-platform-for-vspheredocs"><span class="">Documentation</span></a>
  <ul class="ul-1">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-ml-ops-platform-for-vspheredocsabout-li">
  <input type="checkbox" id="m-ml-ops-platform-for-vspheredocsabout-check"/>
  <label for="m-ml-ops-platform-for-vspheredocsabout-check"><a href="/ml-ops-platform-for-vsphere/docs/about/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-ml-ops-platform-for-vspheredocsabout"><span class="">About</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-ml-ops-platform-for-vspheredocsdeployment-li">
  <input type="checkbox" id="m-ml-ops-platform-for-vspheredocsdeployment-check"/>
  <label for="m-ml-ops-platform-for-vspheredocsdeployment-check"><a href="/ml-ops-platform-for-vsphere/docs/deployment/" class="align-left pl-0  td-sidebar-link td-sidebar-link__section" id="m-ml-ops-platform-for-vspheredocsdeployment"><span class="">Deployment</span></a></label>
  
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-ml-ops-platform-for-vspheredocsdeploymentprerequisites-li">
  <input type="checkbox" id="m-ml-ops-platform-for-vspheredocsdeploymentprerequisites-check"/>
  <label for="m-ml-ops-platform-for-vspheredocsdeploymentprerequisites-check"><a href="/ml-ops-platform-for-vsphere/docs/deployment/prerequisites/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-ml-ops-platform-for-vspheredocsdeploymentprerequisites"><span class="">Prerequisites</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-ml-ops-platform-for-vspheredocsdeploymentnamespace-li">
  <input type="checkbox" id="m-ml-ops-platform-for-vspheredocsdeploymentnamespace-check"/>
  <label for="m-ml-ops-platform-for-vspheredocsdeploymentnamespace-check"><a href="/ml-ops-platform-for-vsphere/docs/deployment/namespace/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-ml-ops-platform-for-vspheredocsdeploymentnamespace"><span class="">Create and configure a vSphere Namespace</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-ml-ops-platform-for-vspheredocsdeploymentcluster-li">
  <input type="checkbox" id="m-ml-ops-platform-for-vspheredocsdeploymentcluster-check"/>
  <label for="m-ml-ops-platform-for-vspheredocsdeploymentcluster-check"><a href="/ml-ops-platform-for-vsphere/docs/deployment/cluster/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-ml-ops-platform-for-vspheredocsdeploymentcluster"><span class="">Create a Tanzu Kubernetes Cluster</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-ml-ops-platform-for-vspheredocsdeploymentcarvel-li">
  <input type="checkbox" id="m-ml-ops-platform-for-vspheredocsdeploymentcarvel-check"/>
  <label for="m-ml-ops-platform-for-vspheredocsdeploymentcarvel-check"><a href="/ml-ops-platform-for-vsphere/docs/deployment/carvel/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-ml-ops-platform-for-vspheredocsdeploymentcarvel"><span class="">Deploy Kubeflow</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-ml-ops-platform-for-vspheredocsdeploymenttroubleshooting-li">
  <input type="checkbox" id="m-ml-ops-platform-for-vspheredocsdeploymenttroubleshooting-check"/>
  <label for="m-ml-ops-platform-for-vspheredocsdeploymenttroubleshooting-check"><a href="/ml-ops-platform-for-vsphere/docs/deployment/troubleshooting/" class="align-left pl-0  td-sidebar-link td-sidebar-link__section" id="m-ml-ops-platform-for-vspheredocsdeploymenttroubleshooting"><span class="">Trouble Shooting</span></a></label>
  
  <ul class="ul-3 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-ml-ops-platform-for-vspheredocsdeploymenttroubleshootingproxy-li">
  <input type="checkbox" id="m-ml-ops-platform-for-vspheredocsdeploymenttroubleshootingproxy-check"/>
  <label for="m-ml-ops-platform-for-vspheredocsdeploymenttroubleshootingproxy-check"><a href="/ml-ops-platform-for-vsphere/docs/deployment/troubleshooting/proxy/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-ml-ops-platform-for-vspheredocsdeploymenttroubleshootingproxy"><span class="">Configure a proxy</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-ml-ops-platform-for-vspheredocsdeploymenttroubleshootingapp-platform-li">
  <input type="checkbox" id="m-ml-ops-platform-for-vspheredocsdeploymenttroubleshootingapp-platform-check"/>
  <label for="m-ml-ops-platform-for-vspheredocsdeploymenttroubleshootingapp-platform-check"><a href="/ml-ops-platform-for-vsphere/docs/deployment/troubleshooting/app-platform/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-ml-ops-platform-for-vspheredocsdeploymenttroubleshootingapp-platform"><span class="">Install Kapp-controller</span></a></label>
  
</li>
  </ul>
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id="m-ml-ops-platform-for-vspheredocskubeflow-tutorial-li">
  <input type="checkbox" id="m-ml-ops-platform-for-vspheredocskubeflow-tutorial-check" checked/>
  <label for="m-ml-ops-platform-for-vspheredocskubeflow-tutorial-check"><a href="/ml-ops-platform-for-vsphere/docs/kubeflow-tutorial/" class="align-left pl-0  td-sidebar-link td-sidebar-link__section" id="m-ml-ops-platform-for-vspheredocskubeflow-tutorial"><span class="">Kubeflow Tutorial</span></a></label>
  
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-ml-ops-platform-for-vspheredocskubeflow-tutoriallab1-li">
  <input type="checkbox" id="m-ml-ops-platform-for-vspheredocskubeflow-tutoriallab1-check"/>
  <label for="m-ml-ops-platform-for-vspheredocskubeflow-tutoriallab1-check"><a href="/ml-ops-platform-for-vsphere/docs/kubeflow-tutorial/lab1/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-ml-ops-platform-for-vspheredocskubeflow-tutoriallab1"><span class="">Lab1 Getting Started</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-ml-ops-platform-for-vspheredocskubeflow-tutoriallab2-li">
  <input type="checkbox" id="m-ml-ops-platform-for-vspheredocskubeflow-tutoriallab2-check"/>
  <label for="m-ml-ops-platform-for-vspheredocskubeflow-tutoriallab2-check"><a href="/ml-ops-platform-for-vsphere/docs/kubeflow-tutorial/lab2/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-ml-ops-platform-for-vspheredocskubeflow-tutoriallab2"><span class="">Lab2 Notebooks</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-ml-ops-platform-for-vspheredocskubeflow-tutoriallab3-li">
  <input type="checkbox" id="m-ml-ops-platform-for-vspheredocskubeflow-tutoriallab3-check"/>
  <label for="m-ml-ops-platform-for-vspheredocskubeflow-tutoriallab3-check"><a href="/ml-ops-platform-for-vsphere/docs/kubeflow-tutorial/lab3/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-ml-ops-platform-for-vspheredocskubeflow-tutoriallab3"><span class="">Lab3 PyTorch Training (PyTorchJob)</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-ml-ops-platform-for-vspheredocskubeflow-tutoriallab4-li">
  <input type="checkbox" id="m-ml-ops-platform-for-vspheredocskubeflow-tutoriallab4-check"/>
  <label for="m-ml-ops-platform-for-vspheredocskubeflow-tutoriallab4-check"><a href="/ml-ops-platform-for-vsphere/docs/kubeflow-tutorial/lab4/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-ml-ops-platform-for-vspheredocskubeflow-tutoriallab4"><span class="">lab4 Model Serving</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-ml-ops-platform-for-vspheredocskubeflow-tutoriallab5_pipelinelab_pipeline-li">
  <input type="checkbox" id="m-ml-ops-platform-for-vspheredocskubeflow-tutoriallab5_pipelinelab_pipeline-check"/>
  <label for="m-ml-ops-platform-for-vspheredocskubeflow-tutoriallab5_pipelinelab_pipeline-check"><a href="/ml-ops-platform-for-vsphere/docs/kubeflow-tutorial/lab5_pipeline/lab_pipeline/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-ml-ops-platform-for-vspheredocskubeflow-tutoriallab5_pipelinelab_pipeline"><span class="">Lab5 Pipeline</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id="m-ml-ops-platform-for-vspheredocskubeflow-tutoriallab5_pipeline_completemarkdownsexample1_facialkeypoint-li">
  <input type="checkbox" id="m-ml-ops-platform-for-vspheredocskubeflow-tutoriallab5_pipeline_completemarkdownsexample1_facialkeypoint-check" checked/>
  <label for="m-ml-ops-platform-for-vspheredocskubeflow-tutoriallab5_pipeline_completemarkdownsexample1_facialkeypoint-check"><a href="/ml-ops-platform-for-vsphere/docs/kubeflow-tutorial/lab5_pipeline_complete/markdowns/example1_facialkeypoint/" class="align-left pl-0  active td-sidebar-link td-sidebar-link__page" id="m-ml-ops-platform-for-vspheredocskubeflow-tutoriallab5_pipeline_completemarkdownsexample1_facialkeypoint"><span class="td-sidebar-nav-active-item"></span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-ml-ops-platform-for-vspheredocskubeflow-tutoriallab5_pipeline_completemarkdownsexample2_gresearch-li">
  <input type="checkbox" id="m-ml-ops-platform-for-vspheredocskubeflow-tutoriallab5_pipeline_completemarkdownsexample2_gresearch-check"/>
  <label for="m-ml-ops-platform-for-vspheredocskubeflow-tutoriallab5_pipeline_completemarkdownsexample2_gresearch-check"><a href="/ml-ops-platform-for-vsphere/docs/kubeflow-tutorial/lab5_pipeline_complete/markdowns/example2_gresearch/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-ml-ops-platform-for-vspheredocskubeflow-tutoriallab5_pipeline_completemarkdownsexample2_gresearch"><span class=""></span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-ml-ops-platform-for-vspheredocskubeflow-tutoriallab5_pipeline_completereadme-li">
  <input type="checkbox" id="m-ml-ops-platform-for-vspheredocskubeflow-tutoriallab5_pipeline_completereadme-check"/>
  <label for="m-ml-ops-platform-for-vspheredocskubeflow-tutoriallab5_pipeline_completereadme-check"><a href="/ml-ops-platform-for-vsphere/docs/kubeflow-tutorial/lab5_pipeline_complete/readme/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-ml-ops-platform-for-vspheredocskubeflow-tutoriallab5_pipeline_completereadme"><span class=""></span></a></label>
  
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-ml-ops-platform-for-vspheredocsvmware-product-li">
  <input type="checkbox" id="m-ml-ops-platform-for-vspheredocsvmware-product-check"/>
  <label for="m-ml-ops-platform-for-vspheredocsvmware-product-check"><a href="/ml-ops-platform-for-vsphere/docs/vmware-product/" class="align-left pl-0  td-sidebar-link td-sidebar-link__section" id="m-ml-ops-platform-for-vspheredocsvmware-product"><span class="">Integration with VMware</span></a></label>
  
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-ml-ops-platform-for-vspheredocsvmware-productbitfusion-li">
  <input type="checkbox" id="m-ml-ops-platform-for-vspheredocsvmware-productbitfusion-check"/>
  <label for="m-ml-ops-platform-for-vspheredocsvmware-productbitfusion-check"><a href="/ml-ops-platform-for-vsphere/docs/vmware-product/bitfusion/" class="align-left pl-0  td-sidebar-link td-sidebar-link__section" id="m-ml-ops-platform-for-vspheredocsvmware-productbitfusion"><span class="">with Bitfusion</span></a></label>
  
  <ul class="ul-3 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-ml-ops-platform-for-vspheredocsvmware-productbitfusionbitfusion-li">
  <input type="checkbox" id="m-ml-ops-platform-for-vspheredocsvmware-productbitfusionbitfusion-check"/>
  <label for="m-ml-ops-platform-for-vspheredocsvmware-productbitfusionbitfusion-check"><a href="/ml-ops-platform-for-vsphere/docs/vmware-product/bitfusion/bitfusion/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-ml-ops-platform-for-vspheredocsvmware-productbitfusionbitfusion"><span class="">Bitfusion</span></a></label>
  
</li>
  </ul>
</li>
  </ul>
</li>
  </ul>
</li>
    </ul>
  </nav>
</div>

          </aside>
          <aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none">
            
<div class="td-page-meta ml-2 pb-1 pt-2 mb-0">
<a href="https://github.com/vmware/ml-ops-platform-for-vsphere//tree/main/website/content/en/docs/kubeflow-tutorial/lab5_pipeline_complete/markdowns/example1_facialKeypoint.md" class="td-page-meta--view" target="_blank" rel="noopener"><i class="fa fa-file-alt fa-fw"></i> View page source</a>
  <a href="https://github.com/vmware/ml-ops-platform-for-vsphere//edit/main/website/content/en/docs/kubeflow-tutorial/lab5_pipeline_complete/markdowns/example1_facialKeypoint.md" class="td-page-meta--edit" target="_blank" rel="noopener"><i class="fa fa-edit fa-fw"></i> Edit this page</a>
  <a href="https://github.com/vmware/ml-ops-platform-for-vsphere//new/main/website/content/en/docs/kubeflow-tutorial/lab5_pipeline_complete/markdowns/example1_facialKeypoint.md?filename=change-me.md&amp;value=---%0Atitle%3A&#43;%22Long&#43;Page&#43;Title%22%0AlinkTitle%3A&#43;%22Short&#43;Nav&#43;Title%22%0Aweight%3A&#43;100%0Adescription%3A&#43;%3E-%0A&#43;&#43;&#43;&#43;&#43;Page&#43;description&#43;for&#43;heading&#43;and&#43;indexes.%0A---%0A%0A%23%23&#43;Heading%0A%0AEdit&#43;this&#43;template&#43;to&#43;create&#43;your&#43;new&#43;page.%0A%0A%2A&#43;Give&#43;it&#43;a&#43;good&#43;name%2C&#43;ending&#43;in&#43;%60.md%60&#43;-&#43;e.g.&#43;%60getting-started.md%60%0A%2A&#43;Edit&#43;the&#43;%22front&#43;matter%22&#43;section&#43;at&#43;the&#43;top&#43;of&#43;the&#43;page&#43;%28weight&#43;controls&#43;how&#43;its&#43;ordered&#43;amongst&#43;other&#43;pages&#43;in&#43;the&#43;same&#43;directory%3B&#43;lowest&#43;number&#43;first%29.%0A%2A&#43;Add&#43;a&#43;good&#43;commit&#43;message&#43;at&#43;the&#43;bottom&#43;of&#43;the&#43;page&#43;%28%3C80&#43;characters%3B&#43;use&#43;the&#43;extended&#43;description&#43;field&#43;for&#43;more&#43;detail%29.%0A%2A&#43;Create&#43;a&#43;new&#43;branch&#43;so&#43;you&#43;can&#43;preview&#43;your&#43;new&#43;file&#43;and&#43;request&#43;a&#43;review&#43;via&#43;Pull&#43;Request.%0A" class="td-page-meta--child" target="_blank" rel="noopener"><i class="fa fa-edit fa-fw"></i> Create child page</a>
  <a href="https://github.com/vmware/ml-ops-platform-for-vsphere//issues/new?title=" class="td-page-meta--issue" target="_blank" rel="noopener"><i class="fab fa-github fa-fw"></i> Create documentation issue</a>
  <a href="https://github.com/vmware/ml-ops-platform-for-vsphere/issues/new" class="td-page-meta--project-issue" target="_blank" rel="noopener"><i class="fas fa-tasks fa-fw"></i> Create project issue</a>
  
</div>

            


<div class="td-toc"><nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#install-kubeflow-pipeline-package">Install Kubeflow Pipeline Package</a></li>
      </ul>
    </li>
    <li><a href="#example-1-facial-keypoint-detection">Example 1: Facial Keypoint Detection</a>
      <ul>
        <li><a href="#about-this-model">About this Model</a></li>
        <li><a href="#design-pipeline-components">Design Pipeline Components</a></li>
        <li><a href="#containernize-pipeline-components">Containernize Pipeline Components</a></li>
        <li><a href="#build-pipeline">Build Pipeline</a></li>
        <li><a href="#run-pipeline">Run Pipeline</a></li>
        <li><a href="#troubleshooting">Troubleshooting</a></li>
      </ul>
    </li>
  </ul>
</nav></div>



            

	
		



  
  

	
		



  
  

	

          </aside>
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            
  

            <nav aria-label="breadcrumb" class="td-breadcrumbs">
  <ol class="breadcrumb">
  <li class="breadcrumb-item">
    <a href="https://vmware.github.io/ml-ops-platform-for-vsphere/docs/">Documentation</a>
  </li>
  <li class="breadcrumb-item">
    <a href="https://vmware.github.io/ml-ops-platform-for-vsphere/docs/kubeflow-tutorial/">Kubeflow Tutorial</a>
  </li>
  <li class="breadcrumb-item active" aria-current="page">
    <a href="https://vmware.github.io/ml-ops-platform-for-vsphere/docs/kubeflow-tutorial/lab5_pipeline_complete/markdowns/example1_facialkeypoint/"></a>
  </li>
  </ol>
</nav>
            
<div class="td-content">
	<h1></h1>
	
	<header class="article-meta">
		

  
    


  
    


  

		
	</header>    
	<h1 id="lab-7-kubeflow-pipeline">Lab 7: Kubeflow Pipeline</h1>
<h3 id="install-kubeflow-pipeline-package">Install Kubeflow Pipeline Package</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="n">kfp</span> <span class="o">--</span><span class="n">upgrade</span> <span class="o">--</span><span class="n">user</span> <span class="o">--</span><span class="n">quiet</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># confirm the kfp sdk</span>
</span></span><span class="line"><span class="cl"><span class="err">!</span> <span class="n">pip</span> <span class="n">show</span> <span class="n">kfp</span>
</span></span></code></pre></div><h2 id="example-1-facial-keypoint-detection">Example 1: Facial Keypoint Detection</h2>
<p>In this example, we would build pipeline components from <em><strong>docker images</strong></em>.</p>
<h3 id="about-this-model">About this Model</h3>
<p>This model comes from Kaggle Competition. The objective of this task is to predict keypoint positions on face images, which can be used as a building block in several applications, such as analysing facial expressions and biometrics recognition.</p>
<p>There are two main tasks: train and evaluation. Each would be build as a pipeline component later.</p>
<p>Datasets for training can be found in <a href="./train/my_data">train/my_data</a>.</p>
<p>More details about this model itself can be found <a href="https://www.kaggle.com/competitions/facial-keypoints-detection">here on Kaggle Competition page</a>.</p>
<h3 id="design-pipeline-components">Design Pipeline Components</h3>
<p>When Kubeflow Pipelines executes a component, a container image is started in a Kubernetes Pod and your componentâ€™s inputs are passed in as command-line arguments.</p>
<p>Therefore, while designing pipeline components, we need to consider following issues:</p>
<ul>
<li>Which inputs can be passed to our component by value? And which inputs, which cannot be directly passed as a command-line argument, should be passed to your component by a reference to the inputâ€™s path?</li>
<li>To return an output from our component, the outputâ€™s data must be stored as a file. We need to let Kubeflow Pipelines know what outputs our component produces, so that when our pipeline runs, Kubeflow Pipelines can pass the paths that we use to store our componentâ€™s outputs as inputs to our component.</li>
<li>Since your inputs and output paths are passed in as command-line arguments, your componentâ€™s code must be able to read inputs from the command line.</li>
</ul>
<p>And in this example, specifically, a component specification should define:</p>
<ul>
<li>The componentâ€™s inputs and outputs</li>
<li>The container image that your componentâ€™s code runs in, the command to use to run your componentâ€™s code, and the command-line arguments to pass to your componentâ€™s code</li>
<li>The componentâ€™s metadata, such as the name and description</li>
</ul>
<p>Note that here as we are going to build each component from docker images, <em><strong><span style="color:blue">you do not need to run</span></strong></em> following code blocks for train and evaluation in this notebook. We mainly guide you through the flow of each component design in this design section.</p>
<h4 id="design-train-component">Design Train Component</h4>
<p>We first design the component for training. Codes can be found in <a href="./train/train.py">train/train.py</a>.</p>
<p>Train component takes three inputs: <code>trial</code>, <code>epoch</code>, and <code>patience</code>, and would export the trained model as output which would later be used as input of model evaluation.</p>
<p>Most codes follow the original workflow of the model itself.</p>
<p><strong>Import packages</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">sklearn.utils</span> <span class="kn">import</span> <span class="n">shuffle</span>           
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>             
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>                
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">tensorflow.keras.models</span> <span class="kn">import</span> <span class="n">load_model</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">shutil</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">argparse</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">autokeras</span> <span class="k">as</span> <span class="nn">ak</span>
</span></span></code></pre></div><p>Among above packages, <code>argparse</code> is specifically useful for our pipeline component design. This package would be used later to parse command-line arguments into component inputs.</p>
<p><strong>Declare input parameters</strong></p>
<p>Remember that when Kubeflow Pipelines executes a component, this componentâ€™s inputs are passed in as command-line arguments. So here we need to define and parse the command-line arguments, using <code>argparse</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--trial&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--epoch&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--patience&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">args</span> <span class="o">=</span> <span class="nb">vars</span><span class="p">(</span><span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">trials</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;trial&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">epochs</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;epoch&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">patience</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;patience&#39;</span><span class="p">]</span>
</span></span></code></pre></div><p>In this example, the Train component takes three inputs as parameters: <code>trial</code>, <code>epoch</code>, and <code>patience</code>. You would need to specify these three inputs before running this pipeline. We would discuss this more in details later in running pipeline section.</p>
<p>Some metadata of this model is declared and defined then, following the model design itself.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">project</span><span class="o">=</span><span class="s2">&#34;Facial-keypoints&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">run_id</span><span class="o">=</span> <span class="s2">&#34;1.8&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">resume_run</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">MAX_TRIALS</span><span class="o">=</span><span class="n">trials</span>
</span></span><span class="line"><span class="cl"><span class="n">EPOCHS</span><span class="o">=</span><span class="n">epochs</span>
</span></span><span class="line"><span class="cl"><span class="n">PATIENCE</span><span class="o">=</span><span class="n">patience</span>
</span></span></code></pre></div><p><strong>Extract data</strong></p>
<p>The model then extracts data and saves the data to attached <em>extenal PVC</em> at location <code>/data</code>. We would later need to specifyc this PVC and let Kubeflow pipelines know what outputs this Train component would produce and where to store later in component specification.</p>
<p>Training dataset and test dataset, in this example, are stored in <a href="./train/my_data">train/my_data</a>. <strong>Remember to change this part if you change the path of datasets storage.</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">base_dir</span><span class="o">=</span><span class="s1">&#39;./train/my_data/&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">train_dir_zip</span><span class="o">=</span><span class="n">base_dir</span><span class="o">+</span><span class="s1">&#39;training.zip&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">test_dir_zip</span><span class="o">=</span><span class="n">base_dir</span><span class="o">+</span><span class="s1">&#39;test.zip&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">zipfile</span> <span class="kn">import</span> <span class="n">ZipFile</span>
</span></span><span class="line"><span class="cl"><span class="k">with</span> <span class="n">ZipFile</span><span class="p">(</span><span class="n">train_dir_zip</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">zipObj</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">zipObj</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="s1">&#39;/data&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Train Archive unzipped&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">with</span> <span class="n">ZipFile</span><span class="p">(</span><span class="n">test_dir_zip</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">zipObj</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">zipObj</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="s1">&#39;/data&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Test Archive unzipped&#34;</span><span class="p">)</span>
</span></span></code></pre></div><p>Note that the overall flow of this data extraction part follows from the original model. The only things we need to change for pipeline component design is the path, i.e. location, for data storage.</p>
<p><strong>Process data</strong></p>
<p>This part, along with following data training part, follow from the model itself. No more changes needed for pipeline component design for this part.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">train_dir</span><span class="o">=</span><span class="s1">&#39;/data/training.csv&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">test_dir</span><span class="o">=</span><span class="s1">&#39;/data/test.csv&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">train</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">train_dir</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">test</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">test_dir</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">train</span><span class="o">=</span><span class="n">train</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">train</span><span class="o">=</span><span class="n">train</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">X_train</span><span class="o">=</span><span class="p">[]</span>
</span></span><span class="line"><span class="cl"><span class="n">Y_train</span><span class="o">=</span><span class="p">[]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">train</span><span class="p">[</span><span class="s1">&#39;Image&#39;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="n">X_train</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">split</span><span class="p">(),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">96</span><span class="p">,</span><span class="mi">96</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">X_train</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">X_train</span><span class="p">,(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">96</span><span class="p">,</span><span class="mi">96</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">X_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">((</span><span class="n">train</span><span class="p">))):</span> 
</span></span><span class="line"><span class="cl">    <span class="n">Y_train</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">train</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">30</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl"><span class="n">Y_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">Y_train</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
</span></span></code></pre></div><p><strong>Train data</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">reg</span> <span class="o">=</span> <span class="n">ak</span><span class="o">.</span><span class="n">ImageRegressor</span><span class="p">(</span><span class="n">max_trials</span><span class="o">=</span><span class="n">MAX_TRIALS</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">reg</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">,</span> <span class="n">validation_split</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="n">EPOCHS</span><span class="p">)</span>
</span></span></code></pre></div><p><strong>Export trained model</strong></p>
<p>Finally, we need to export our trained model to our externally attached PVC, so that our Evaluate component can then take this trained model as input.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">my_model</span> <span class="o">=</span> <span class="n">reg</span><span class="o">.</span><span class="n">export_model</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">my_model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;/data/model_autokeras&#39;</span><span class="p">,</span> <span class="n">save_format</span><span class="o">=</span><span class="s2">&#34;tf&#34;</span><span class="p">)</span>
</span></span></code></pre></div><h4 id="design-evaluation-component">Design Evaluation Component</h4>
<p>We then design our Evaluation component. Codes can be found in <a href="./evaluate/eval.py">evaluation/eval.py</a>.</p>
<p>This component takes the trained model as input. Some of the results, the submission file, would be directly printed out in log. The complete results, which is a pretty big file, would be saved as a <code>.csv</code> in PVC.</p>
<p>The overall logic follows from original model design.</p>
<p><strong>Import packages</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">tensorflow.keras.models</span> <span class="kn">import</span> <span class="n">load_model</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">autokeras</span> <span class="k">as</span> <span class="nn">ak</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span></span></code></pre></div><p><strong>Load and view trained model</strong></p>
<p>First, we need to load our trained model, the output of our Train component.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">loaded_model</span> <span class="o">=</span> <span class="n">load_model</span><span class="p">(</span><span class="s2">&#34;/data/model_autokeras&#34;</span><span class="p">,</span> <span class="n">custom_objects</span><span class="o">=</span><span class="n">ak</span><span class="o">.</span><span class="n">CUSTOM_OBJECTS</span><span class="p">)</span>
</span></span></code></pre></div><p>You may print the trained model summary, and you can see these printed contents in <code>main-logs</code> in <code>Output artifacts</code> on Kubeflow UI after the pipeline finishes running. More details on this would be discussed later in running pipeline section.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1">### Pint model summary</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">loaded_model</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">test_dir</span><span class="o">=</span><span class="s1">&#39;/data/test.csv&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">test</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">test_dir</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">X_test</span><span class="o">=</span><span class="p">[]</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">test</span><span class="p">[</span><span class="s1">&#39;Image&#39;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="n">X_test</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">split</span><span class="p">(),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">96</span><span class="p">,</span><span class="mi">96</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">X_test</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">X_test</span><span class="p">,(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">96</span><span class="p">,</span><span class="mi">96</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">X_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
</span></span></code></pre></div><p><strong>Predict</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">y_pred</span> <span class="o">=</span> <span class="n">loaded_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
</span></span></code></pre></div><p><strong>Create submission file</strong></p>
<p>As the submission file is pretty big, we store it under <code>/data</code> in our PVC container, the same place where we extract our training and testing data into. For you to have a quick look, we also directly print part of it, which would be displayed in <code>main-logs</code> after pipeline finishes running.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">y_pred</span><span class="o">=</span> <span class="n">y_pred</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,)</span>
</span></span><span class="line"><span class="cl"><span class="n">submission</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;Location&#39;</span><span class="p">:</span> <span class="n">y_pred</span><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="n">submission</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;/data/submission.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span> <span class="p">,</span> <span class="n">index_label</span><span class="o">=</span><span class="s1">&#39;RowId&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;/data/submission.csv&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;***********************************************&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
</span></span></code></pre></div><h3 id="containernize-pipeline-components">Containernize Pipeline Components</h3>
<p>Now, we have gone through and understood the logic of pipeline component design. We then start to containernize our pipeline components.</p>
<h4 id="write-dockerfile">Write Dockerfile</h4>
<p>We use Docker to build images. Basically, Docker can build images automatically by reading the instructions from a Dockerfile. A Dockerfile is a text document that contains all the commands a user could call on the command line to assemble an image.</p>
<p>Instructions and details of how to write a Dockerfile can be found on <a href="https://docs.docker.com/engine/reference/builder/">Docker&rsquo;s official docs</a>.</p>
<p>In this example, we provide you with following Dockerfile for Train component and Evaluate component.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-dockerfile" data-lang="dockerfile"><span class="line"><span class="cl"><span class="k">FROM</span><span class="s"> &#34;ubuntu&#34;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> apt-get update <span class="o">&amp;&amp;</span> yes <span class="p">|</span> apt-get upgrade<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> mkdir -p /tensorflow/models<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> apt-get install -y git python3-pip<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> pip3 install --upgrade pip<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> pip3 install tensorflow<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> pip3 install jupyter<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> pip3 install matplotlib<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> pip3 install <span class="nv">kfp</span><span class="o">==</span>1.1.2<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> pip install opencv-python-headless<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> pip3 install pandas keras <span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> pip3 install sklearn<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> pip3 install autokeras<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> . /<span class="err">
</span></span></span></code></pre></div><p>Codes can be found in both <code>train/Dockerfile</code> and <code>evaluate/Dockerfile</code>.</p>
<h4 id="build-docker-images">Build Docker Images</h4>
<p>Build docker images for Train component and Evaluate component using <code>docker run</code> command.</p>
<p>More details about <code>docker run</code> commands can be found on <a href="https://docs.docker.com/engine/reference/commandline/run/">here</a></p>
<p><em><strong>OPTION 1</strong></em></p>
<p>We have already prepared you built image. If you did not personalize the codes or change the paths of files, feel free to directly use them and skip this part. The location of the image is already in pipeline generation codes.</p>
<p>You may also pull the image to your local if you want.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="err">!</span><span class="n">docker</span> <span class="n">pull</span> <span class="n">harbor</span><span class="o">-</span><span class="n">repo</span><span class="o">.</span><span class="n">vmware</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">zxintong</span><span class="o">/</span><span class="n">docker_images</span><span class="nd">@sha256</span><span class="p">:</span><span class="mi">48</span><span class="n">cb43365f65adffc16db98bc6a05e62c13ab5dff7579d381cf8ef8d2e1da489</span>
</span></span></code></pre></div><p>If you are Mac with M1 chip, you may need to pull following image:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="err">!</span><span class="n">docker</span> <span class="n">pull</span> <span class="n">harbor</span><span class="o">-</span><span class="n">repo</span><span class="o">.</span><span class="n">vmware</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">zxintong</span><span class="o">/</span><span class="n">docker_images</span><span class="nd">@sha256</span><span class="p">:</span><span class="mi">3418</span><span class="n">cabc178b04a24e0f2b767ccaf4cc0e3fad68c3a6f407b4508ace433b5d83</span>
</span></span></code></pre></div><p><em><strong>OPTION 2</strong></em></p>
<p>Or, you can also build Docker images on your own locally</p>
<p><strong>Install Docker</strong></p>
<p>Make sure Docker is <a href="https://docs.docker.com/engine/install/">installed</a> in your environment. And login after install.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="err">!</span><span class="n">docker</span> <span class="n">login</span>
</span></span></code></pre></div><p><strong>Build images</strong></p>
<p>Use <code>docker build</code> command to build Docker images.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="err">!</span><span class="n">docker</span> <span class="n">build</span> <span class="o">-</span><span class="n">f</span> <span class="o">&lt;</span><span class="n">dockerfile_path</span><span class="o">&gt;</span> <span class="o">-</span><span class="n">t</span> <span class="o">&lt;</span><span class="n">docker_username</span><span class="o">&gt;/&lt;</span><span class="n">docker_imagename</span><span class="o">&gt;</span><span class="p">:</span><span class="o">&lt;</span><span class="n">tag</span><span class="o">&gt;</span> <span class="o">.</span>
</span></span></code></pre></div><p>If you only have one Dockerfile where you run above command, you may not need to specify <code>-f &lt;dockerfile_path&gt;</code>.</p>
<p>Feel free to directly run following command to build docker image in this notebook, if you did not change paths of files.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="err">!</span><span class="n">docker</span> <span class="n">build</span> <span class="o">-</span><span class="n">t</span> <span class="n">docker_images</span><span class="p">:</span><span class="n">facial</span> <span class="o">.</span>
</span></span></code></pre></div><p>Or, you can also build images for train and evaluate separately.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="err">!</span><span class="n">cd</span> <span class="n">train</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="err">!</span><span class="n">docker</span> <span class="n">build</span> <span class="o">-</span><span class="n">t</span> <span class="n">docker_images</span><span class="p">:</span><span class="n">facial_train</span> <span class="o">.</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="err">!</span><span class="n">cd</span> <span class="o">../</span><span class="n">evaluate</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="err">!</span><span class="n">docker</span> <span class="n">build</span> <span class="o">-</span><span class="n">t</span> <span class="n">docker_images</span><span class="p">:</span><span class="n">facial_eval</span> <span class="o">.</span>
</span></span></code></pre></div><p><em><strong>Note: if you are Mac M1 chip user, you may need to add following flag to <code>docker run</code></strong></em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="err">!</span><span class="n">docker</span> <span class="n">build</span> <span class="o">--</span><span class="n">platform</span> <span class="n">linux</span><span class="o">/</span><span class="n">amd64</span> <span class="o">-</span><span class="n">f</span> <span class="o">&lt;</span><span class="n">dockerfile_path</span><span class="o">&gt;</span> <span class="o">-</span><span class="n">t</span> <span class="o">&lt;</span><span class="n">docker_username</span><span class="o">&gt;/&lt;</span><span class="n">docker_imagename</span><span class="o">&gt;</span><span class="p">:</span><span class="o">&lt;</span><span class="n">tag</span><span class="o">&gt;</span> <span class="o">.</span>
</span></span></code></pre></div><h3 id="build-pipeline">Build Pipeline</h3>
<p>So far we have finished designing pipeline components and containernizing them. It is now time for our pipeline generation.</p>
<h4 id="create-component-specifications">Create Component Specifications</h4>
<p>As discussed at the beginning introduction part, we need to first define component specifications which include</p>
<ul>
<li>The componentâ€™s inputs and outputs</li>
<li>The container image that your componentâ€™s code runs in, the command to use to run your componentâ€™s code, and the command-line arguments to pass to your componentâ€™s code</li>
<li>The componentâ€™s metadata, such as the name and description</li>
</ul>
<p><strong>Import Kubeflow Pipeline packages</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">kfp</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">kfp</span> <span class="kn">import</span> <span class="n">dsl</span>
</span></span></code></pre></div><p><strong>Login to Docker if necessary</strong></p>
<p>If you want to use your own docker images stored locally, you may need to first login to Docker.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="err">!</span><span class="n">docker</span> <span class="n">login</span> <span class="c1"># is not needed if you use our images, or store your image somewhere else</span>
</span></span></code></pre></div><p><strong>Train Component</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Train component takes three inputs: trial, epoch, and patience</span>
</span></span><span class="line"><span class="cl"><span class="c1"># return a ContainerOp instance, representing Train step in pipeline</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">Train</span><span class="p">(</span><span class="n">trial</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">patience</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">vop</span> <span class="o">=</span> <span class="n">dsl</span><span class="o">.</span><span class="n">VolumeOp</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&#34;pvc&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                       <span class="n">resource_name</span><span class="o">=</span><span class="s2">&#34;pvc&#34;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s1">&#39;1Gi&#39;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                       <span class="n">modes</span><span class="o">=</span><span class="n">dsl</span><span class="o">.</span><span class="n">VOLUME_MODE_RWO</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">dsl</span><span class="o">.</span><span class="n">ContainerOp</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Train&#39;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">        <span class="n">image</span> <span class="o">=</span> <span class="s1">&#39;harbor-repo.vmware.com/zxintong/docker_images@sha256:48cb43365f65adffc16db98bc6a05e62c13ab5dff7579d381cf8ef8d2e1da489&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># IF YOU ARE MAC M1 CHIP USER, USER FOLLOWING</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># image = &#39;harbor-repo.vmware.com/zxintong/docker_images@sha256:3418cabc178b04a24e0f2b767ccaf4cc0e3fad68c3a6f407b4508ace433b5d83&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;python3&#39;</span><span class="p">,</span> <span class="s1">&#39;/train/train.py&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="n">arguments</span><span class="o">=</span><span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;--trial&#39;</span><span class="p">,</span> <span class="n">trial</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;--epoch&#39;</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;--patience&#39;</span><span class="p">,</span> <span class="n">patience</span>
</span></span><span class="line"><span class="cl">        <span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="n">pvolumes</span><span class="o">=</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;/data&#39;</span><span class="p">:</span> <span class="n">vop</span><span class="o">.</span><span class="n">volume</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span></code></pre></div><p>First, we need to create and specify the persistent volume (PVC) for data storage, creating a <code>VolumeOP</code> instance.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">vop</span> <span class="o">=</span> <span class="n">dsl</span><span class="o">.</span><span class="n">VolumeOp</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&#34;pvc&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                       <span class="n">resource_name</span><span class="o">=</span><span class="s2">&#34;pvc&#34;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s1">&#39;1Gi&#39;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                       <span class="n">modes</span><span class="o">=</span><span class="n">dsl</span><span class="o">.</span><span class="n">VOLUME_MODE_RWO</span><span class="p">)</span>
</span></span></code></pre></div><p>We then create a <code>ContainerOp</code> instance, which would be understood and used as &ldquo;a step&rdquo; in our pipeline, and return this &ldquo;step&rdquo;.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">return</span> <span class="n">dsl</span><span class="o">.</span><span class="n">ContainerOp</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Train&#39;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">        <span class="n">image</span> <span class="o">=</span> <span class="s1">&#39;harbor-repo.vmware.com/zxintong/docker_images@sha256:48cb43365f65adffc16db98bc6a05e62c13ab5dff7579d381cf8ef8d2e1da489&#39;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">        <span class="c1"># IF YOU ARE MAC M1 CHIP USER, USER FOLLOWING</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># image = &#39;harbor-repo.vmware.com/zxintong/docker_images@sha256:3418cabc178b04a24e0f2b767ccaf4cc0e3fad68c3a6f407b4508ace433b5d83&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;python3&#39;</span><span class="p">,</span> <span class="s1">&#39;/train/train.py&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="n">arguments</span><span class="o">=</span><span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;--trial&#39;</span><span class="p">,</span> <span class="n">trial</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;--epoch&#39;</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;--patience&#39;</span><span class="p">,</span> <span class="n">patience</span>
</span></span><span class="line"><span class="cl">        <span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="n">pvolumes</span><span class="o">=</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;/data&#39;</span><span class="p">:</span> <span class="n">vop</span><span class="o">.</span><span class="n">volume</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span></code></pre></div><p>We need to specify the inputs (<code>trial</code>, <code>epoch</code>, and <code>patience</code>) in <code>arguments</code>, container image in <code>image</code>, and volume for data storage in <code>pvolumes</code>. Note that here in <code>image</code>, we provide you with our built images, containing both <code>train</code> folder and <code>evaluate</code> folder, stored on our internal Harbor repo. If you want to use your own image, please remember to change this value.</p>
<p>We also need to specify <code>command</code>. In this provided case, as we containernize the image at root directory, in command we need <code>python3 /train/train.py</code>. (If you containernize Train component and Evaluate component one by one in each own folder, you may need to change this value to <code>python3 train.py</code>.)</p>
<p><strong>Evaluate Component</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Evaluate component takes Train ContainerOp as input, and access Train ContainerOp&#39;s pvolumes to get the trained model stored in it</span>
</span></span><span class="line"><span class="cl"><span class="c1"># return a ContainerOp instance representing Evaluate step in pipeline</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">Evaluate</span><span class="p">(</span><span class="n">comp1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">dsl</span><span class="o">.</span><span class="n">ContainerOp</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Evaluate&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">image</span> <span class="o">=</span> <span class="s1">&#39;harbor-repo.vmware.com/zxintong/docker_images@sha256:48cb43365f65adffc16db98bc6a05e62c13ab5dff7579d381cf8ef8d2e1da489&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># IF YOU ARE MAC M1 CHIP USER, USER FOLLOWING</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># image = &#39;harbor-repo.vmware.com/zxintong/docker_images@sha256:3418cabc178b04a24e0f2b767ccaf4cc0e3fad68c3a6f407b4508ace433b5d83&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="n">pvolumes</span><span class="o">=</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;/data&#39;</span><span class="p">:</span> <span class="n">comp1</span><span class="o">.</span><span class="n">pvolumes</span><span class="p">[</span><span class="s1">&#39;/data&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;python3&#39;</span><span class="p">,</span> <span class="s1">&#39;/eval/eval.py&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span></code></pre></div><p>Again, we need to create a <code>ContainerOp</code> instance and return it, to be used as a step in our pipeline.</p>
<p>Here, we provide container image in <code>image</code>, and command to run the python file for evaluation in <code>command</code>. Similary, remember to change these two values if you want to use your own docker images or if you containernize the component under different directory.</p>
<p>For Evaluate component, it does not need explicit argument by value. Instead, it takes the trained model as input. This trained model is generated by Train component, and cannot be passed directly by value, so we need to &ldquo;pass&rdquo; it by reference. The way we do this here is to store the trained model in <code>/data</code>, our attached externally PVC, so that as long as we specify this PVC here in <code>pvolumes</code>, the Evaluate component would be able to access our trained model.</p>
<h4 id="generate-pipeline">Generate Pipeline</h4>
<p>We are now ready to define out <code>pipeline</code> instance.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="nd">@dsl</span><span class="o">.</span><span class="n">pipeline</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;facial keypoints detection pipeline&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">description</span> <span class="o">=</span> <span class="s1">&#39;pipeline to detect facial keypoints&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">generate_pipeline</span><span class="p">(</span><span class="n">trial</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">patience</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">comp1</span> <span class="o">=</span> <span class="n">Train</span><span class="p">(</span><span class="n">trial</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">patience</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">comp2</span> <span class="o">=</span> <span class="n">Evaluate</span><span class="p">(</span><span class="n">comp1</span><span class="p">)</span>
</span></span></code></pre></div><p>Run above function to build our pipeline.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="kn">import</span> <span class="nn">kfp.compiler</span> <span class="k">as</span> <span class="nn">compiler</span>
</span></span><span class="line"><span class="cl">  <span class="n">compiler</span><span class="o">.</span><span class="n">Compiler</span><span class="p">()</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">generate_pipeline</span><span class="p">,</span> <span class="s1">&#39;face_pipeline&#39;</span> <span class="o">+</span> <span class="s1">&#39;.yaml&#39;</span><span class="p">)</span>
</span></span></code></pre></div><p>You should now be able to see a file called <code>face_pipeline.yaml</code> in current directory, same as this notebook.</p>
<h3 id="run-pipeline">Run Pipeline</h3>
<p>In our last cell, we compile our pipeline as a YAML file.</p>
<p>Note that for testing purpose, we also provide you with two already-compiled pipeline YAML files, <code>face_pipeline_test_default.yaml</code> and <code>face_pipeline_test_amd64.yaml</code>. Feel free to directly download and use them.</p>
<p>To run this pipeline, go to Kubeflow UI. Navigate to Pipelines Page. Upload this pipeline by choosing &ldquo;upload a file&rdquo; option. Choose the YAML file we created just now.</p>
<p><img src="./img/face1.png" alt="face1"></p>
<p><img src="./img/face2.png" alt="face2"></p>
<p><img src="./img/face3.png" alt="face3"></p>
<p>After the pipeline uploading process finishes, you should be able to see the pipeline graph. Create a experiment for this pipeline, and then create a run.</p>
<p><img src="./img/face4.png" alt="face4"></p>
<p>You need to enter values for the three required inputs for Train: trial, epoch, and patience.</p>
<p><img src="./img/face5.png" alt="face5"></p>
<p>The pipeline would start to run then. You would be able to see the running process in Runs Page on Kubeflow UI.</p>
<p><img src="./img/face6.png" alt="face6"></p>
<p>The pipeline running may take some time, especially when you input a large trial or epoch. There would be a green symbol appears next to each component after its completion. And you can always click on each component to see its details, such as its input/output, volumes, logs, and pod.</p>
<p><img src="./img/face7.png" alt="face7"></p>
<p>After the whole pipeline finishes running, click on Train Component and Evaluate Component, you should be able to see <code>main-logs</code> under Input/Output, Output artifacts. Click into it, you should then be able to see the detailed logs, and part of the submission, i.e. output of Evaluate Component.</p>
<p>Example logs are provided in <a href="./logs">logs</a> folders.</p>
<h3 id="troubleshooting">Troubleshooting</h3>

	
	
	<div class="text-muted mt-5 pt-3 border-top">
  Last modified November 2, 2022: <a href="https://github.com/vmware/ml-ops-platform-for-vsphere//commit/ea33ff7e3eaa88a7b3afec9d81b5e40846d0e212">add Kubeflow on vSphere website (ea33ff7)</a>
</div>

</div>


          </main>
        </div>
      </div>
      
<footer class="bg-dark pt-3 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
      </div>
      <div class="col text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2022 Copyright VMware, Inc.</small>
        
	
      </div>
    </div>
  </div>
</footer>


    </div>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
    integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
    crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js"
    integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA=="
    crossorigin="anonymous"></script>





<script src='/ml-ops-platform-for-vsphere/js/tabpane-persist.js'></script>


















<script src="/ml-ops-platform-for-vsphere/js/main.min.996daafaf2da35aed251c4a4417605fd236f955837f403643c6117bf904daa5f.js" integrity="sha256-mW2q&#43;vLaNa7SUcSkQXYF/SNvlVg39ANkPGEXv5BNql8=" crossorigin="anonymous"></script>




<script src="/ml-ops-platform-for-vsphere/js/copy-code-button.min.js"></script>




  </body>
</html>